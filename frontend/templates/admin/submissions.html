{% extends "admin/base_admin.html" %}

{% block title %}Contact Submissions{% endblock %}
{% block page_title %}Contact Submissions{% endblock %}

{% block content %}
<div class="submissions-container">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Messages</h2>
            <div class="filter-buttons">
                <button class="btn btn-secondary active" data-filter="all">All</button>
                <button class="btn btn-secondary" data-filter="unread">Unread</button>
            </div>
        </div>
        <div class="card-body">
            {% if submissions %}
            <div class="submissions-list" id="submissionsList">
                {% for submission in submissions %}
                <div class="submission-item {% if not submission.is_read %}unread{% endif %}" data-id="{{ submission.id }}">
                    <div class="submission-header">
                        <div class="submission-sender">
                            <strong>{{ submission.name }}</strong>
                            <span class="submission-email">{{ submission.email }}</span>
                        </div>
                        <div class="submission-meta">
                            {% if not submission.is_read %}
                            <span class="badge badge-info">New</span>
                            {% endif %}
                            <span class="submission-date">{{ submission.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                        </div>
                    </div>
                    {% if submission.subject %}
                    <div class="submission-subject">{{ submission.subject }}</div>
                    {% endif %}
                    <div class="submission-preview">{{ submission.message[:150] }}{% if submission.message|length > 150 %}...{% endif %}</div>
                    <div class="submission-actions">
                        <button class="btn btn-secondary btn-icon view-submission" data-submission='{{ submission|tojson }}' title="View">
                            <span class="material-icons">visibility</span>
                        </button>
                        {% if not submission.is_read %}
                        <button class="btn btn-secondary btn-icon mark-read" data-id="{{ submission.id }}" title="Mark as Read">
                            <span class="material-icons">done</span>
                        </button>
                        {% else %}
                        <button class="btn btn-secondary btn-icon mark-unread" data-id="{{ submission.id }}" title="Mark as Unread">
                            <span class="material-icons">markunread</span>
                        </button>
                        {% endif %}
                        <button class="btn btn-danger btn-icon delete-submission" data-id="{{ submission.id }}" title="Delete">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <span class="material-icons">inbox</span>
                <h3>No submissions yet</h3>
                <p>Contact form submissions will appear here</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- View Submission Modal -->
<div class="modal-overlay" id="viewModal">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Message Details</h3>
            <button class="modal-close" onclick="closeViewModal()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="detail-row">
                <label>From:</label>
                <span id="viewName"></span>
            </div>
            <div class="detail-row">
                <label>Email:</label>
                <a id="viewEmail" href=""></a>
            </div>
            <div class="detail-row" id="viewPhoneRow" style="display: none;">
                <label>Phone:</label>
                <span id="viewPhone"></span>
            </div>
            <div class="detail-row" id="viewServiceRow" style="display: none;">
                <label>Service Interest:</label>
                <span id="viewService"></span>
            </div>
            <div class="detail-row" id="viewSubjectRow" style="display: none;">
                <label>Subject:</label>
                <span id="viewSubject"></span>
            </div>
            <div class="detail-row">
                <label>Date:</label>
                <span id="viewDate"></span>
            </div>
            <div class="message-content">
                <label>Message:</label>
                <div id="viewMessage"></div>
            </div>
        </div>
        <div class="modal-footer">
            <a id="replyLink" href="" class="btn btn-primary">
                <span class="material-icons">reply</span>
                Reply via Email
            </a>
        </div>
    </div>
</div>

<style>
.filter-buttons {
    display: flex;
    gap: 8px;
}

.filter-buttons .btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.submissions-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.submission-item {
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    transition: all 0.2s;
}

.submission-item:hover {
    border-color: var(--primary);
}

.submission-item.unread {
    background: var(--primary-light);
    border-left: 4px solid var(--primary);
}

.submission-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.submission-sender strong {
    display: block;
    font-size: 15px;
}

.submission-email {
    font-size: 13px;
    color: var(--text-secondary);
}

.submission-meta {
    display: flex;
    align-items: center;
    gap: 12px;
}

.submission-date {
    font-size: 12px;
    color: var(--text-secondary);
}

.submission-subject {
    font-weight: 500;
    margin-bottom: 4px;
}

.submission-preview {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.submission-actions {
    display: flex;
    gap: 8px;
}

.detail-row {
    display: flex;
    margin-bottom: 12px;
}

.detail-row label {
    width: 120px;
    font-weight: 500;
    color: var(--text-secondary);
}

.detail-row a {
    color: var(--primary);
}

.message-content {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.message-content label {
    display: block;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

#viewMessage {
    background: var(--background);
    padding: 16px;
    border-radius: 8px;
    white-space: pre-wrap;
    line-height: 1.6;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('viewModal');
    const filterButtons = document.querySelectorAll('.filter-buttons .btn');

    // Filter buttons
    filterButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            filterButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const filter = this.dataset.filter;
            const items = document.querySelectorAll('.submission-item');

            items.forEach(item => {
                if (filter === 'all') {
                    item.style.display = '';
                } else if (filter === 'unread') {
                    item.style.display = item.classList.contains('unread') ? '' : 'none';
                }
            });
        });
    });

    // View submission
    document.querySelectorAll('.view-submission').forEach(btn => {
        btn.addEventListener('click', function() {
            const submission = JSON.parse(this.dataset.submission);

            document.getElementById('viewName').textContent = submission.name;
            document.getElementById('viewEmail').textContent = submission.email;
            document.getElementById('viewEmail').href = 'mailto:' + submission.email;
            document.getElementById('replyLink').href = 'mailto:' + submission.email + '?subject=Re: ' + (submission.subject || 'Your Inquiry');

            if (submission.phone) {
                document.getElementById('viewPhone').textContent = submission.phone;
                document.getElementById('viewPhoneRow').style.display = '';
            } else {
                document.getElementById('viewPhoneRow').style.display = 'none';
            }

            if (submission.service_interest) {
                document.getElementById('viewService').textContent = submission.service_interest;
                document.getElementById('viewServiceRow').style.display = '';
            } else {
                document.getElementById('viewServiceRow').style.display = 'none';
            }

            if (submission.subject) {
                document.getElementById('viewSubject').textContent = submission.subject;
                document.getElementById('viewSubjectRow').style.display = '';
            } else {
                document.getElementById('viewSubjectRow').style.display = 'none';
            }

            document.getElementById('viewDate').textContent = new Date(submission.created_at).toLocaleString();
            document.getElementById('viewMessage').textContent = submission.message;

            modal.classList.add('show');

            // Mark as read if unread
            if (!submission.is_read) {
                markRead(submission.id);
            }
        });
    });

    // Mark as read
    document.querySelectorAll('.mark-read').forEach(btn => {
        btn.addEventListener('click', function() {
            markRead(this.dataset.id);
        });
    });

    // Mark as unread
    document.querySelectorAll('.mark-unread').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            try {
                await fetch(`/api/admin/submissions/${id}/read`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_read: false })
                });
                location.reload();
            } catch (error) {
                showToast('Error updating submission', 'error');
            }
        });
    });

    // Delete submission
    document.querySelectorAll('.delete-submission').forEach(btn => {
        btn.addEventListener('click', async function() {
            const id = this.dataset.id;
            const confirmed = await showConfirm('Delete Submission', 'Are you sure you want to delete this submission?');

            if (confirmed) {
                try {
                    await fetch(`/api/admin/submissions/${id}`, { method: 'DELETE' });
                    location.reload();
                } catch (error) {
                    showToast('Error deleting submission', 'error');
                }
            }
        });
    });

    async function markRead(id) {
        try {
            await fetch(`/api/admin/submissions/${id}/read`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_read: true })
            });

            const item = document.querySelector(`.submission-item[data-id="${id}"]`);
            if (item) {
                item.classList.remove('unread');
                const badge = item.querySelector('.badge-info');
                if (badge) badge.remove();
            }
        } catch (error) {
            console.error('Error marking as read:', error);
        }
    }
});

function closeViewModal() {
    document.getElementById('viewModal').classList.remove('show');
}
</script>
{% endblock %}
