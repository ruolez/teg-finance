{% extends "admin/base_admin.html" %}

{% block title %}{% if page %}Edit Page{% else %}New Page{% endif %}{% endblock %}
{% block page_title %}{% if page %}Edit Page{% else %}New Page{% endif %}{% endblock %}

{% block head %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="editor-container">
    <form id="pageForm">
        <input type="hidden" id="pageId" value="{{ page.id if page else '' }}">

        <div class="editor-main">
            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label for="title">Page Title *</label>
                        <input type="text" id="title" class="form-control" value="{{ page.title if page else '' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="slug">URL Slug *</label>
                        <div class="slug-input">
                            <span class="slug-prefix">/{% if page and page.is_service_page %}services/{% endif %}</span>
                            <input type="text" id="slug" class="form-control" value="{{ page.slug if page else '' }}" required>
                        </div>
                        <p class="form-hint">The URL path for this page (no spaces, use hyphens)</p>
                    </div>

                    <div class="form-group">
                        <label>Content</label>
                        <div id="editor">{{ page.content|safe if page else '' }}</div>
                        <input type="hidden" id="content" name="content">
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-sidebar">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Publish</h3>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" id="isPublished" {% if page and page.is_published %}checked{% endif %}>
                        <label for="isPublished">Published</label>
                    </div>
                    <div class="publish-actions">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="material-icons">save</span>
                            Save
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Page Type</h3>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" id="isServicePage" {% if page and page.is_service_page %}checked{% endif %}>
                        <label for="isServicePage">Service Page</label>
                    </div>
                    <p class="form-hint">Service pages appear in the Services menu</p>

                    <div class="form-group" id="serviceOptions" style="{% if not page or not page.is_service_page %}display: none;{% endif %}">
                        <label for="serviceIcon">Icon</label>
                        <select id="serviceIcon" class="form-control">
                            <option value="">Select an icon</option>
                            <option value="calculate" {% if page and page.service_icon == 'calculate' %}selected{% endif %}>Calculate</option>
                            <option value="business" {% if page and page.service_icon == 'business' %}selected{% endif %}>Business</option>
                            <option value="book" {% if page and page.service_icon == 'book' %}selected{% endif %}>Book</option>
                            <option value="assessment" {% if page and page.service_icon == 'assessment' %}selected{% endif %}>Assessment</option>
                            <option value="trending_up" {% if page and page.service_icon == 'trending_up' %}selected{% endif %}>Trending Up</option>
                            <option value="account_balance" {% if page and page.service_icon == 'account_balance' %}selected{% endif %}>Account Balance</option>
                            <option value="receipt" {% if page and page.service_icon == 'receipt' %}selected{% endif %}>Receipt</option>
                            <option value="description" {% if page and page.service_icon == 'description' %}selected{% endif %}>Description</option>
                        </select>

                        <label for="serviceOrder" style="margin-top: 12px;">Order</label>
                        <input type="number" id="serviceOrder" class="form-control" value="{{ page.service_order if page else 0 }}" min="0">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">SEO</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="metaTitle">Meta Title</label>
                        <input type="text" id="metaTitle" class="form-control" value="{{ page.meta_title if page else '' }}" maxlength="60">
                        <p class="form-hint">Max 60 characters</p>
                    </div>

                    <div class="form-group">
                        <label for="metaDescription">Meta Description</label>
                        <textarea id="metaDescription" class="form-control" rows="3" maxlength="160">{{ page.meta_description if page else '' }}</textarea>
                        <p class="form-hint">Max 160 characters</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Hero Image</h3>
                </div>
                <div class="card-body">
                    <div class="hero-image-preview" id="heroPreview">
                        {% if page and page.hero_image_filename %}
                        <img src="/uploads/{{ page.hero_image_filename }}" alt="Hero image">
                        {% else %}
                        <span class="material-icons">image</span>
                        <span>No image selected</span>
                        {% endif %}
                    </div>
                    <input type="hidden" id="heroImageId" value="{{ page.hero_image_id if page else '' }}">
                    <button type="button" class="btn btn-secondary" id="selectHeroBtn" style="width: 100%;">
                        <span class="material-icons">photo_library</span>
                        Select Image
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Image Picker Modal -->
<div class="modal-overlay" id="imagePickerModal">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Select Image</h3>
            <button class="modal-close" onclick="closeImagePicker()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="image-grid" id="imageGrid">
                {% for image in images %}
                <div class="image-item" data-id="{{ image.id }}" data-filename="{{ image.filename }}">
                    <img src="/uploads/{{ image.filename }}" alt="{{ image.alt_text or image.original_filename }}">
                </div>
                {% endfor %}
            </div>
            {% if not images %}
            <div class="empty-state">
                <span class="material-icons">photo_library</span>
                <p>No images uploaded yet</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.editor-container {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
    max-width: 1400px;
}

.editor-main .card-body {
    padding: 24px;
}

.slug-input {
    display: flex;
    align-items: center;
}

.slug-prefix {
    background: var(--background);
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-right: none;
    border-radius: 8px 0 0 8px;
    color: var(--text-secondary);
    font-size: 14px;
}

.slug-input .form-control {
    border-radius: 0 8px 8px 0;
}

#editor {
    height: 400px;
    background: white;
}

.publish-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.publish-actions .btn {
    flex: 1;
}

.hero-image-preview {
    width: 100%;
    height: 160px;
    background: var(--background);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    margin-bottom: 12px;
    overflow: hidden;
}

.hero-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.hero-image-preview .material-icons {
    font-size: 48px;
    color: var(--border);
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
}

.image-item {
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 3px solid transparent;
    transition: border-color 0.2s;
}

.image-item:hover {
    border-color: var(--primary);
}

.image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

@media (max-width: 1024px) {
    .editor-container {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script src="/static/js/admin/editor.js"></script>
{% endblock %}
